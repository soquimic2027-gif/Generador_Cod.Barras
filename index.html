<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de Etiquetas Zebra</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#1e293b,#0f172a);min-height:100vh;color:#fff}
    .app{display:flex;height:100vh}
    .sidebar{width:280px;background:#1e293b;padding:15px;overflow-y:auto;border-right:1px solid #334155}
    .main{flex:1;display:flex;flex-direction:column}
    .toolbar{background:#1e293b;padding:10px 20px;display:flex;gap:10px;align-items:center;border-bottom:1px solid #334155;flex-wrap:wrap}
    .canvas-area{flex:1;padding:20px;overflow:auto;display:flex;align-items:center;justify-content:center;background:#0f172a}
    .right-panel{width:280px;background:#1e293b;padding:15px;overflow-y:auto;border-left:1px solid #334155}
    h2{font-size:.85rem;margin-bottom:12px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px}
    .btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-size:.85rem;transition:all .2s;display:inline-flex;align-items:center;gap:5px}
    .btn-blue{background:#2563eb;color:#fff}.btn-blue:hover{background:#1d4ed8}
    .btn-green{background:#16a34a;color:#fff}.btn-green:hover{background:#15803d}
    .btn-purple{background:#7c3aed;color:#fff}.btn-purple:hover{background:#6d28d9}
    .btn-orange{background:#ea580c;color:#fff}.btn-orange:hover{background:#c2410c}
    .btn-gray{background:#475569;color:#fff}.btn-gray:hover{background:#64748b}
    .btn-sm{padding:6px 10px;font-size:.8rem}
    input,select{width:100%;padding:8px 10px;border:1px solid #475569;border-radius:6px;background:#334155;color:#fff;font-size:.85rem}
    input:focus,select:focus{outline:none;border-color:#3b82f6}
    label{display:block;font-size:.8rem;color:#94a3b8;margin-bottom:4px}
    .form-group{margin-bottom:12px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .element-btn{width:100%;padding:12px;margin-bottom:8px;background:#334155;border:1px solid #475569;border-radius:8px;color:#fff;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;transition:all .2s}
    .element-btn:hover{background:#475569}
    .element-btn span{font-size:1.2rem}
    .label-canvas{background:#fff;position:relative;box-shadow:0 8px 30px rgba(0,0,0,.4);border:2px solid #3b82f6}
    .element{position:absolute;cursor:grab;user-select:none}
    .element:active{cursor:grabbing}
    .element.selected{outline:2px solid #3b82f6}
    .resize-handle{position:absolute;width:10px;height:10px;background:#3b82f6;border:2px solid #fff;z-index:10}
    .resize-handle.nw{top:-5px;left:-5px;cursor:nw-resize}
    .resize-handle.ne{top:-5px;right:-5px;cursor:ne-resize}
    .resize-handle.sw{bottom:-5px;left:-5px;cursor:sw-resize}
    .resize-handle.se{bottom:-5px;right:-5px;cursor:se-resize}
    .resize-handle.n{top:-5px;left:50%;transform:translateX(-50%);cursor:n-resize}
    .resize-handle.s{bottom:-5px;left:50%;transform:translateX(-50%);cursor:s-resize}
    .resize-handle.e{right:-5px;top:50%;transform:translateY(-50%);cursor:e-resize}
    .resize-handle.w{left:-5px;top:50%;transform:translateY(-50%);cursor:w-resize}
    .tabs{display:flex;gap:5px;margin-bottom:15px}
    .tab{flex:1;padding:8px;background:#334155;border:none;color:#94a3b8;cursor:pointer;border-radius:6px;font-size:.8rem}
    .tab.active{background:#2563eb;color:#fff}
    .codes-list{max-height:150px;overflow-y:auto;background:#0f172a;border-radius:6px;padding:8px}
    .code-item{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:#1e293b;margin-bottom:4px;border-radius:4px;font-size:.8rem}
    .code-item button{background:none;border:none;color:#f87171;cursor:pointer;font-size:1rem}
    .divider{height:1px;background:#334155;margin:15px 0}
    .prop-section{background:#0f172a;border-radius:8px;padding:12px;margin-bottom:12px}
    .prop-section h4{font-size:.8rem;color:#60a5fa;margin-bottom:10px}
    .info-text{font-size:.75rem;color:#64748b;margin-top:4px}
    .zpl-preview{background:#0f172a;color:#4ade80;padding:10px;border-radius:6px;font-family:monospace;font-size:.6rem;max-height:80px;overflow:auto;white-space:pre-wrap}
    .upload-area{border:2px dashed #475569;border-radius:8px;padding:15px;text-align:center;margin-bottom:12px}
    .upload-area input{display:none}
    .hidden{display:none}
    .toast{position:fixed;bottom:20px;right:20px;background:#16a34a;color:#fff;padding:12px 20px;border-radius:8px;z-index:1000}
    .preview-section{background:#0f172a;border-radius:8px;padding:15px;margin-bottom:15px}
    .preview-info{background:#334155;padding:12px;border-radius:6px;text-align:center}
    .preview-info strong{color:#4ade80;font-size:1.2rem}
    .preview-nav{display:flex;align-items:center;justify-content:center;gap:15px;margin-top:12px}
    .preview-nav button{background:#475569;border:none;color:#fff;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:1rem}
    .preview-nav button:hover{background:#64748b}
    .download-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
  </style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <h2>‚ûï ELEMENTOS</h2>
    <button class="element-btn" onclick="addElement('barcode')"><span>üìä</span> C√≥digo de Barras</button>
    <button class="element-btn" onclick="addElement('text')"><span>üìù</span> Texto</button>
    <button class="element-btn" onclick="addElement('line')"><span>‚ûñ</span> L√≠nea</button>
    <button class="element-btn" onclick="addElement('rect')"><span>‚¨ú</span> Rect√°ngulo</button>
    
    <div class="divider"></div>
    
    <h2>üìê TAMA√ëO ETIQUETA</h2>
    <div class="form-group">
      <label>Tama√±o predeterminado</label>
      <select id="presetSize" onchange="applyPresetSize()">
        <option value="custom">Personalizado</option>
        <option value="150x100" selected>Grande (15 √ó 10 cm)</option>
        <option value="30x20">Peque√±o (3 √ó 2 cm)</option>
        <option value="100x70">Mediano (10 √ó 7 cm)</option>
        <option value="50x30">Est√°ndar (5 √ó 3 cm)</option>
        <option value="100x50">Largo (10 √ó 5 cm)</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Ancho (mm)</label><input type="number" id="labelWidth" value="150" onchange="updateLabelSize()"></div>
      <div class="form-group"><label>Alto (mm)</label><input type="number" id="labelHeight" value="100" onchange="updateLabelSize()"></div>
    </div>
    <div class="form-group">
      <label>DPI</label>
      <select id="dpi" onchange="updateLabelSize()">
        <option value="203">203 DPI</option>
        <option value="300">300 DPI</option>
      </select>
    </div>
    
    <div class="divider"></div>
    
    <h2>üìã C√ìDIGOS A IMPRIMIR</h2>
    <div class="tabs">
      <button class="tab active" onclick="showCodesTab('manual')">Manual</button>
      <button class="tab" onclick="showCodesTab('excel')">Excel</button>
    </div>
    <div id="manualTab">
      <div class="form-row">
        <input type="text" id="newCode" placeholder="C√≥digo" oninput="this.value=this.value.toUpperCase()">
        <input type="number" id="newQty" value="1" min="1" style="width:60px">
      </div>
      <button class="btn btn-green btn-sm" style="width:100%;margin-top:8px" onclick="addCode()">+ Agregar</button>
    </div>
    <div id="excelTab" class="hidden">
      <div class="upload-area">
        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="loadExcel(event)">
        <label for="excelFile" class="btn btn-blue btn-sm">üìÅ Cargar Excel</label>
      </div>
      <button class="btn btn-gray btn-sm" style="width:100%" onclick="downloadTemplate()">üì• Plantilla</button>
    </div>
    <div class="codes-list" id="codesList" style="margin-top:12px"></div>
    <p class="info-text">Total etiquetas: <strong id="totalLabels">0</strong></p>
  </div>

  <div class="main">
    <div class="toolbar">
      <button class="btn btn-gray" onclick="deleteSelected()">üóëÔ∏è Eliminar</button>
      <button class="btn btn-gray" onclick="duplicateSelected()">üìã Duplicar</button>
      <div style="flex:1"></div>
      <button class="btn btn-blue" onclick="copyZPL()">üìã Copiar ZPL</button>
      <button class="btn btn-green" onclick="downloadZPL()">üíæ Descargar .ZPL</button>
    </div>
    <div class="canvas-area">
      <div class="label-canvas" id="labelCanvas"></div>
    </div>
  </div>

  <div class="right-panel">
    <h2>üìã C√ìDIGO ACTUAL</h2>
    <div class="preview-section">
      <div class="preview-info">
        <span style="color:#94a3b8;font-size:.8rem;">Mostrando:</span><br>
        <strong id="currentCodeDisplay">ABC123</strong>
      </div>
      <div class="preview-nav">
        <button onclick="prevPreview()">‚óÄ</button>
        <span id="previewInfo" style="color:#fff;">1 / 1</span>
        <button onclick="nextPreview()">‚ñ∂</button>
      </div>
    </div>
    
    <h2>üì• DESCARGAR</h2>
    <div class="download-btns">
      <button class="btn btn-orange btn-sm" onclick="downloadJPG()">üì∑ JPG</button>
      <button class="btn btn-purple btn-sm" onclick="downloadPNG()">üñºÔ∏è PNG</button>
    </div>
    <button class="btn btn-green btn-sm" style="width:100%;margin-top:8px" onclick="downloadAllImages()">üì¶ Todas</button>
    
    <div class="divider"></div>
    
    <h2>üìã PLANTILLAS</h2>
    <button class="btn btn-blue btn-sm" style="width:100%;margin-bottom:8px" onclick="loadWarehouseTemplate()">üè≠ Almac√©n Grande</button>
    <button class="btn btn-blue btn-sm" style="width:100%;margin-bottom:8px" onclick="loadSmallTemplate()">üè∑Ô∏è Etiqueta Peque√±a</button>
    <button class="btn btn-gray btn-sm" style="width:100%" onclick="clearAll()">üóëÔ∏è Limpiar Todo</button>
    
    <div class="divider"></div>
    
    <h2>‚öôÔ∏è PROPIEDADES</h2>
    <div id="noSelection" class="prop-section"><p style="color:#64748b;font-size:.85rem;text-align:center;">Selecciona un elemento</p></div>
    
    <div id="elementProps" class="hidden">
      <div class="prop-section">
        <h4>üìç Posici√≥n</h4>
        <div class="form-row">
          <div class="form-group"><label>X (mm)</label><input type="number" id="propX" onchange="updateProp('x')"></div>
          <div class="form-group"><label>Y (mm)</label><input type="number" id="propY" onchange="updateProp('y')"></div>
        </div>
      </div>
      
      <div id="textProps" class="prop-section hidden">
        <h4>üìù Texto</h4>
        <div class="form-group"><label>Contenido ({CODE} = variable)</label><input type="text" id="propText" onchange="updateProp('text')"></div>
        <div class="form-row">
          <div class="form-group"><label>Tama√±o</label><input type="number" id="propFontH" onchange="updateProp('fontH')"></div>
          <div class="form-group"><label>Rotaci√≥n</label>
            <select id="propRotation" onchange="updateProp('rotation')">
              <option value="N">0¬∞</option><option value="R">90¬∞</option><option value="I">180¬∞</option><option value="B">270¬∞</option>
            </select>
          </div>
        </div>
      </div>
      
      <div id="barcodeProps" class="prop-section hidden">
        <h4>üìä C√≥digo de Barras</h4>
        <div class="form-row">
          <div class="form-group"><label>Altura</label><input type="number" id="propBarcodeH" onchange="updateProp('barcodeH')"></div>
          <div class="form-group"><label>Ancho</label><input type="number" id="propBarcodeW" min="1" max="10" onchange="updateProp('barcodeW')"></div>
        </div>
        <div class="form-group"><label>Rotaci√≥n</label>
          <select id="propBarcodeRotation" onchange="updateProp('rotation')">
            <option value="N">0¬∞</option><option value="R">90¬∞</option><option value="I">180¬∞</option><option value="B">270¬∞</option>
          </select>
        </div>
        <div class="form-group"><label><input type="checkbox" id="propShowText" onchange="updateProp('showText')" checked> Mostrar texto</label></div>
      </div>
      
      <div id="lineProps" class="prop-section hidden">
        <h4>‚ûñ L√≠nea</h4>
        <div class="form-row">
          <div class="form-group"><label>Largo (mm)</label><input type="number" id="propLineW" onchange="updateProp('w')"></div>
          <div class="form-group"><label>Grosor</label><input type="number" id="propLineThick" min="1" onchange="updateProp('lineThick')"></div>
        </div>
      </div>
      
      <div id="rectProps" class="prop-section hidden">
        <h4>‚¨ú Rect√°ngulo</h4>
        <div class="form-row">
          <div class="form-group"><label>Ancho</label><input type="number" id="propRectW" onchange="updateProp('w')"></div>
          <div class="form-group"><label>Alto</label><input type="number" id="propRectH" onchange="updateProp('h')"></div>
        </div>
        <div class="form-group"><label>Grosor borde</label><input type="number" id="propRectThick" min="1" onchange="updateProp('rectThick')"></div>
      </div>
    </div>
    
    <div class="divider"></div>
    <h2>üìÑ C√ìDIGO ZPL</h2>
    <div class="zpl-preview" id="zplPreview">^XA^XZ</div>
  </div>
</div>

<script>
const SCALE=3;
let elements=[],selectedId=null,codes=[],currentPreviewIdx=0,dragging=null,resizing=null,dragOffset={x:0,y:0},resizeStart={};

const CODE128={' ':'11011001100','!':'11001101100','"':'11001100110','#':'10010011000','$':'10010001100','%':'10001001100','&':'10011001000',"'":'10011000100','(':'10001100100',')':'11001001000','*':'11001000100','+':'11000100100',',':'10110011100','-':'10011011100','.':'10011001110','/':'10111001100','0':'10011101100','1':'11001110010','2':'11001011100','3':'11001001110','4':'11011100100','5':'11001110100','6':'11101101110','7':'11101001100','8':'11100101100','9':'11100100110',':':'11101100100',';':'11100110100','<':'11100110010','=':'11011011000','>':'11011000110','?':'11000110110','@':'10100011000','A':'10001011000','B':'10001000110','C':'10110001000','D':'10001101000','E':'10001100010','F':'11010001000','G':'11000101000','H':'11000100010','I':'10110111000','J':'10110001110','K':'10001101110','L':'10111011000','M':'10111000110','N':'10001110110','O':'11101110110','P':'11010001110','Q':'11000101110','R':'11011101000','S':'11011100010','T':'11011101110','U':'11101011000','V':'11101000110','W':'11100010110','X':'11101101000','Y':'11101100010','Z':'11100011010','[':'11101111010','\\':'11001000010',']':'11110001010','^':'10100110000','_':'10100001100','START_B':'11010010000','STOP':'1100011101011'};

function mmToDots(mm){return Math.round(mm*(+document.getElementById('dpi').value/25.4))}
function mmToPx(mm){return mm*SCALE}
function pxToMm(px){return Math.round(px/SCALE*10)/10}
function getCurrentCode(){return codes.length>0&&codes[currentPreviewIdx]?codes[currentPreviewIdx].code:'ABC123'}

function updateLabelSize(){
  const w=+document.getElementById('labelWidth').value||150;
  const h=+document.getElementById('labelHeight').value||100;
  document.getElementById('labelCanvas').style.width=mmToPx(w)+'px';
  document.getElementById('labelCanvas').style.height=mmToPx(h)+'px';
  renderElements();
}

function applyPresetSize(){
  const p=document.getElementById('presetSize').value;
  if(p==='custom')return;
  const[w,h]=p.split('x').map(Number);
  document.getElementById('labelWidth').value=w;
  document.getElementById('labelHeight').value=h;
  updateLabelSize();
}

function addElement(type){
  const el={id:Date.now(),type,x:10,y:10};
  if(type==='text')Object.assign(el,{text:'Texto',fontH:35,rotation:'N'});
  else if(type==='barcode')Object.assign(el,{barcodeH:60,barcodeW:2,showText:true,barcodeData:'{CODE}',rotation:'N'});
  else if(type==='line')Object.assign(el,{w:50,lineThick:3});
  else if(type==='rect')Object.assign(el,{w:30,h:20,rectThick:2});
  elements.push(el);
  selectElement(el.id);
}

function drawBarcode(ctx,value,x,y,height,moduleW,showText,rotation){
  let pattern=CODE128['START_B'],checksum=104;
  for(let i=0;i<value.length;i++){if(CODE128[value[i]]){pattern+=CODE128[value[i]];checksum+=(i+1)*(value[i].charCodeAt(0)-32)}}
  const chk=String.fromCharCode((checksum%103)+32);
  if(CODE128[chk])pattern+=CODE128[chk];
  pattern+=CODE128['STOP'];
  
  ctx.save();
  ctx.translate(x,y);
  if(rotation==='R')ctx.rotate(Math.PI/2);
  else if(rotation==='I')ctx.rotate(Math.PI);
  else if(rotation==='B')ctx.rotate(-Math.PI/2);
  
  ctx.fillStyle='#000';
  for(let i=0;i<pattern.length;i++){if(pattern[i]==='1')ctx.fillRect(i*moduleW,0,moduleW,height)}
  if(showText){ctx.font='bold 12px Arial';ctx.textAlign='center';ctx.fillText(value,(pattern.length*moduleW)/2,height+14)}
  ctx.restore();
  return{w:pattern.length*moduleW,h:height+(showText?18:0)};
}

function renderElements(){
  const canvas=document.getElementById('labelCanvas');
  canvas.innerHTML='';
  const code=getCurrentCode();
  
  elements.forEach(el=>{
    const div=document.createElement('div');
    div.className='element'+(el.id===selectedId?' selected':'');
    div.style.left=mmToPx(el.x)+'px';
    div.style.top=mmToPx(el.y)+'px';
    
    if(el.type==='text'){
      div.style.fontSize=(el.fontH/2.5)+'px';
      div.style.fontFamily='Arial,sans-serif';
      div.style.fontWeight='bold';
      div.style.color='#000';
      div.style.whiteSpace='nowrap';
      div.textContent=el.text.replace(/{CODE}/g,code);
      if(el.rotation==='R')div.style.transform='rotate(90deg)';
      else if(el.rotation==='I')div.style.transform='rotate(180deg)';
      else if(el.rotation==='B')div.style.transform='rotate(-90deg)';
    }else if(el.type==='barcode'){
      const data=el.barcodeData.replace(/{CODE}/g,code);
      const c=document.createElement('canvas');
      const ctx=c.getContext('2d');
      let pattern=CODE128['START_B'];
      for(let i=0;i<data.length;i++)if(CODE128[data[i]])pattern+=CODE128[data[i]];
      pattern+=CODE128['STOP'];
      const bw=el.barcodeW,bh=el.barcodeH;
      const w=pattern.length*bw+10,h=bh+(el.showText?20:5);
      
      if(el.rotation==='N'||el.rotation==='I'){c.width=w;c.height=h;div.style.width=w+'px';div.style.height=h+'px'}
      else{c.width=h;c.height=w;div.style.width=h+'px';div.style.height=w+'px'}
      
      ctx.fillStyle='#fff';ctx.fillRect(0,0,c.width,c.height);
      if(el.rotation==='N')drawBarcode(ctx,data,5,2,bh,bw,el.showText,'N');
      else if(el.rotation==='R'){ctx.translate(c.width,0);ctx.rotate(Math.PI/2);drawBarcode(ctx,data,5,2,bh,bw,el.showText,'N')}
      else if(el.rotation==='I'){ctx.translate(c.width,c.height);ctx.rotate(Math.PI);drawBarcode(ctx,data,5,2,bh,bw,el.showText,'N')}
      else if(el.rotation==='B'){ctx.translate(0,c.height);ctx.rotate(-Math.PI/2);drawBarcode(ctx,data,5,2,bh,bw,el.showText,'N')}
      
      c.style.pointerEvents='none';
      div.appendChild(c);
    }else if(el.type==='line'){
      div.style.width=mmToPx(el.w)+'px';
      div.style.height=el.lineThick+'px';
      div.style.background='#000';
    }else if(el.type==='rect'){
      div.style.width=mmToPx(el.w)+'px';
      div.style.height=mmToPx(el.h)+'px';
      div.style.border=el.rectThick+'px solid #000';
    }
    
    if(el.id===selectedId){
      ['nw','n','ne','e','se','s','sw','w'].forEach(pos=>{
        const h=document.createElement('div');
        h.className='resize-handle '+pos;
        h.onmousedown=e=>startResize(e,el.id,pos);
        div.appendChild(h);
      });
    }
    
    div.onmousedown=e=>{if(!e.target.classList.contains('resize-handle'))startDrag(e,el.id)};
    canvas.appendChild(div);
  });
  
  updatePreview();
  updateZPL();
}

function startDrag(e,id){
  e.preventDefault();
  selectElement(id);
  dragging=id;
  const el=elements.find(x=>x.id===id);
  const rect=document.getElementById('labelCanvas').getBoundingClientRect();
  dragOffset={x:e.clientX-rect.left-mmToPx(el.x),y:e.clientY-rect.top-mmToPx(el.y)};
  document.onmousemove=onDrag;
  document.onmouseup=stopDrag;
}

function onDrag(e){
  if(!dragging)return;
  const rect=document.getElementById('labelCanvas').getBoundingClientRect();
  const el=elements.find(x=>x.id===dragging);
  el.x=Math.max(0,pxToMm(e.clientX-rect.left-dragOffset.x));
  el.y=Math.max(0,pxToMm(e.clientY-rect.top-dragOffset.y));
  renderElements();
  updatePropsPanel();
}

function stopDrag(){dragging=null;document.onmousemove=null;document.onmouseup=null}

function startResize(e,id,handle){
  e.stopPropagation();
  resizing={id,handle};
  const el=elements.find(x=>x.id===id);
  resizeStart={x:el.x,y:el.y,w:el.w||20,h:el.h||10,barcodeW:el.barcodeW||2,barcodeH:el.barcodeH||50,fontH:el.fontH||30,mouseX:e.clientX,mouseY:e.clientY};
  document.onmousemove=onResize;
  document.onmouseup=stopResize;
}

function onResize(e){
  if(!resizing)return;
  const el=elements.find(x=>x.id===resizing.id);
  const dx=pxToMm(e.clientX-resizeStart.mouseX),dy=pxToMm(e.clientY-resizeStart.mouseY);
  const h=resizing.handle;
  
  if(el.type==='barcode'){
    if(h.includes('e')||h.includes('w'))el.barcodeW=Math.max(1,Math.min(10,resizeStart.barcodeW+(h.includes('e')?dx/10:-dx/10)));
    if(h.includes('s')||h.includes('n'))el.barcodeH=Math.max(20,resizeStart.barcodeH+(h.includes('s')?dy*2:-dy*2));
  }else if(el.type==='text'){
    el.fontH=Math.max(15,resizeStart.fontH+Math.max(dx,dy)*2);
  }else{
    if(h.includes('e'))el.w=Math.max(5,resizeStart.w+dx);
    if(h.includes('s'))el.h=Math.max(5,resizeStart.h+dy);
    if(h.includes('w')){el.w=Math.max(5,resizeStart.w-dx);el.x=resizeStart.x+dx}
    if(h.includes('n')){el.h=Math.max(5,resizeStart.h-dy);el.y=resizeStart.y+dy}
  }
  renderElements();
  updatePropsPanel();
}

function stopResize(){resizing=null;document.onmousemove=null;document.onmouseup=null}

function selectElement(id){selectedId=id;renderElements();updatePropsPanel()}

function updatePropsPanel(){
  document.getElementById('noSelection').classList.toggle('hidden',!!selectedId);
  document.getElementById('elementProps').classList.toggle('hidden',!selectedId);
  if(!selectedId)return;
  
  const el=elements.find(x=>x.id===selectedId);
  document.getElementById('propX').value=el.x;
  document.getElementById('propY').value=el.y;
  
  document.getElementById('textProps').classList.add('hidden');
  document.getElementById('barcodeProps').classList.add('hidden');
  document.getElementById('lineProps').classList.add('hidden');
  document.getElementById('rectProps').classList.add('hidden');
  
  if(el.type==='text'){
    document.getElementById('textProps').classList.remove('hidden');
    document.getElementById('propText').value=el.text;
    document.getElementById('propFontH').value=el.fontH;
    document.getElementById('propRotation').value=el.rotation;
  }else if(el.type==='barcode'){
    document.getElementById('barcodeProps').classList.remove('hidden');
    document.getElementById('propBarcodeH').value=el.barcodeH;
    document.getElementById('propBarcodeW').value=el.barcodeW;
    document.getElementById('propBarcodeRotation').value=el.rotation||'N';
    document.getElementById('propShowText').checked=el.showText;
  }else if(el.type==='line'){
    document.getElementById('lineProps').classList.remove('hidden');
    document.getElementById('propLineW').value=el.w;
    document.getElementById('propLineThick').value=el.lineThick;
  }else if(el.type==='rect'){
    document.getElementById('rectProps').classList.remove('hidden');
    document.getElementById('propRectW').value=el.w;
    document.getElementById('propRectH').value=el.h;
    document.getElementById('propRectThick').value=el.rectThick;
  }
}

function updateProp(prop){
  const el=elements.find(x=>x.id===selectedId);
  if(!el)return;
  const map={x:'propX',y:'propY',text:'propText',fontH:'propFontH',rotation:el.type==='barcode'?'propBarcodeRotation':'propRotation',barcodeH:'propBarcodeH',barcodeW:'propBarcodeW',showText:'propShowText',w:el.type==='line'?'propLineW':'propRectW',h:'propRectH',lineThick:'propLineThick',rectThick:'propRectThick'};
  const input=document.getElementById(map[prop]);
  if(!input)return;
  el[prop]=input.type==='checkbox'?input.checked:isNaN(+input.value)?input.value:+input.value;
  renderElements();
}

function deleteSelected(){if(selectedId){elements=elements.filter(x=>x.id!==selectedId);selectedId=null;renderElements();updatePropsPanel()}}
function duplicateSelected(){const el=elements.find(x=>x.id===selectedId);if(el){const copy={...el,id:Date.now(),x:el.x+5,y:el.y+5};elements.push(copy);selectElement(copy.id)}}

function updatePreview(){
  document.getElementById('currentCodeDisplay').textContent=getCurrentCode();
  document.getElementById('previewInfo').textContent=`${currentPreviewIdx+1} / ${Math.max(codes.length,1)}`;
}

function prevPreview(){currentPreviewIdx=(currentPreviewIdx-1+Math.max(codes.length,1))%Math.max(codes.length,1);renderElements()}
function nextPreview(){currentPreviewIdx=(currentPreviewIdx+1)%Math.max(codes.length,1);renderElements()}

function showCodesTab(tab){
  document.querySelectorAll('.tabs .tab').forEach((t,i)=>t.classList.toggle('active',(tab==='manual'?0:1)===i));
  document.getElementById('manualTab').classList.toggle('hidden',tab!=='manual');
  document.getElementById('excelTab').classList.toggle('hidden',tab!=='excel');
}

function addCode(){
  const code=document.getElementById('newCode').value.trim().toUpperCase();
  const qty=Math.max(1,+document.getElementById('newQty').value||1);
  if(!code)return;
  codes.push({code,qty});
  document.getElementById('newCode').value='';
  currentPreviewIdx=codes.length-1;
  renderCodes();
  renderElements();
}

function removeCode(i){codes.splice(i,1);if(currentPreviewIdx>=codes.length)currentPreviewIdx=Math.max(0,codes.length-1);renderCodes();renderElements()}

function renderCodes(){
  const list=document.getElementById('codesList');
  document.getElementById('totalLabels').textContent=codes.reduce((s,c)=>s+c.qty,0);
  list.innerHTML=codes.length?codes.map((c,i)=>`<div class="code-item" style="${i===currentPreviewIdx?'background:#2563eb':''}"><span>${c.code} (√ó${c.qty})</span><button onclick="removeCode(${i})">‚úï</button></div>`).join(''):'<p style="color:#64748b;text-align:center;font-size:.8rem">Sin c√≥digos</p>';
}

function loadExcel(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=evt=>{
    const data=new Uint8Array(evt.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:''});
    const headers=(json[0]||[]).map(h=>String(h).toLowerCase());
    const codeIdx=headers.findIndex(h=>h.includes('codigo')||h.includes('code'));
    const qtyIdx=headers.findIndex(h=>h.includes('cantidad')||h.includes('qty'));
    for(let i=1;i<json.length;i++){
      const code=String(json[i][codeIdx!==-1?codeIdx:0]||'').trim().toUpperCase();
      if(code)codes.push({code,qty:parseInt(json[i][qtyIdx!==-1?qtyIdx:1])||1});
    }
    renderCodes();renderElements();
  };
  reader.readAsArrayBuffer(file);
  e.target.value='';
}

function downloadTemplate(){
  const ws=XLSX.utils.aoa_to_sheet([['Codigo','Cantidad'],['ABC123',2],['XYZ789',5]]);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Codigos');
  XLSX.writeFile(wb,'plantilla.xlsx');
}

function generateZPL(codeValue){
  const w=mmToDots(+document.getElementById('labelWidth').value);
  const h=mmToDots(+document.getElementById('labelHeight').value);
  let zpl=`^XA\n^PW${w}\n^LL${h}\n`;
  elements.forEach(el=>{
    const x=mmToDots(el.x),y=mmToDots(el.y);
    if(el.type==='text'){
      const text=el.text.replace(/{CODE}/g,codeValue);
      zpl+=`^FO${x},${y}^A0${el.rotation||'N'},${el.fontH},${el.fontH}^FD${text}^FS\n`;
    }else if(el.type==='barcode'){
      const data=(el.barcodeData||'{CODE}').replace(/{CODE}/g,codeValue);
      zpl+=`^FO${x},${y}^BY${el.barcodeW}^BC${el.rotation||'N'},${el.barcodeH},${el.showText?'Y':'N'},N,N^FD${data}^FS\n`;
    }else if(el.type==='line'){
      zpl+=`^FO${x},${y}^GB${mmToDots(el.w)},${el.lineThick},${el.lineThick}^FS\n`;
    }else if(el.type==='rect'){
      zpl+=`^FO${x},${y}^GB${mmToDots(el.w)},${mmToDots(el.h)},${el.rectThick}^FS\n`;
    }
  });
  return zpl+'^XZ';
}

function updateZPL(){document.getElementById('zplPreview').textContent=generateZPL(getCurrentCode())}

function generateAllZPL(){
  if(!codes.length)return generateZPL('ABC123');
  return codes.map(c=>generateZPL(c.code).replace('^XZ',`^PQ${c.qty}\n^XZ`)).join('\n\n');
}

function copyZPL(){navigator.clipboard.writeText(generateAllZPL());showToast('‚úì ZPL copiado')}
function downloadZPL(){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([generateAllZPL()],{type:'text/plain'}));
  a.download='etiquetas.zpl';
  a.click();
  showToast('‚úì Archivo .ZPL descargado');
}

function generateImage(code,scale){
  const w=+document.getElementById('labelWidth').value,h=+document.getElementById('labelHeight').value;
  const c=document.createElement('canvas');c.width=w*scale;c.height=h*scale;
  const ctx=c.getContext('2d');ctx.fillStyle='#fff';ctx.fillRect(0,0,c.width,c.height);
  
  elements.forEach(el=>{
    const x=el.x*scale,y=el.y*scale;
    if(el.type==='text'){
      ctx.save();ctx.fillStyle='#000';ctx.font=`bold ${el.fontH*scale/2.5}px Arial`;
      ctx.translate(x,y+el.fontH*scale/3);
      if(el.rotation==='R')ctx.rotate(Math.PI/2);else if(el.rotation==='I')ctx.rotate(Math.PI);else if(el.rotation==='B')ctx.rotate(-Math.PI/2);
      ctx.fillText(el.text.replace(/{CODE}/g,code),0,0);
      ctx.restore();
    }else if(el.type==='barcode'){
      const data=(el.barcodeData||'{CODE}').replace(/{CODE}/g,code);
      drawBarcode(ctx,data,x,y,el.barcodeH*scale/50,el.barcodeW*scale/5,el.showText,el.rotation||'N');
    }else if(el.type==='line'){
      ctx.fillStyle='#000';ctx.fillRect(x,y,el.w*scale,el.lineThick*scale/3);
    }else if(el.type==='rect'){
      ctx.strokeStyle='#000';ctx.lineWidth=el.rectThick*scale/3;ctx.strokeRect(x,y,el.w*scale,el.h*scale);
    }
  });
  return c;
}

function downloadJPG(){const c=generateImage(getCurrentCode(),10);const a=document.createElement('a');a.download=`etiqueta_${getCurrentCode()}.jpg`;a.href=c.toDataURL('image/jpeg',.95);a.click()}
function downloadPNG(){const c=generateImage(getCurrentCode(),10);const a=document.createElement('a');a.download=`etiqueta_${getCurrentCode()}.png`;a.href=c.toDataURL('image/png');a.click()}
function downloadAllImages(){(codes.length?codes:[{code:'ABC123'}]).forEach((c,i)=>setTimeout(()=>{const cv=generateImage(c.code,10);const a=document.createElement('a');a.download=`etiqueta_${c.code}.jpg`;a.href=cv.toDataURL('image/jpeg',.95);a.click()},i*300))}

function clearAll(){elements=[];selectedId=null;renderElements();updatePropsPanel()}

function loadWarehouseTemplate(){
  document.getElementById('labelWidth').value=150;document.getElementById('labelHeight').value=100;document.getElementById('presetSize').value='150x100';
  elements=[
    {id:Date.now(),type:'text',x:8,y:5,text:'NOMBRE PRODUCTO',fontH:60,rotation:'N'},
    {id:Date.now()+1,type:'line',x:8,y:24,w:135,lineThick:3},
    {id:Date.now()+2,type:'text',x:8,y:28,text:'C√ìDIGO: {CODE}',fontH:32,rotation:'N'},
    {id:Date.now()+3,type:'text',x:8,y:40,text:'LOTE: ____________',fontH:32,rotation:'N'},
    {id:Date.now()+4,type:'text',x:8,y:52,text:'F. INGRESO: __/__/____',fontH:30,rotation:'N'},
    {id:Date.now()+5,type:'text',x:8,y:62,text:'F. PRODUCCI√ìN: __/__/____',fontH:30,rotation:'N'},
    {id:Date.now()+6,type:'text',x:8,y:72,text:'F. VENCIMIENTO: __/__/____',fontH:30,rotation:'N'},
    {id:Date.now()+7,type:'text',x:8,y:84,text:'CANTIDAD: _______ KG',fontH:32,rotation:'N'},
    {id:Date.now()+8,type:'barcode',x:108,y:28,barcodeH:100,barcodeW:2,showText:true,barcodeData:'{CODE}',rotation:'R'}
  ];
  updateLabelSize();
}

function loadSmallTemplate(){
  document.getElementById('labelWidth').value=30;document.getElementById('labelHeight').value=20;document.getElementById('presetSize').value='30x20';
  elements=[{id:Date.now(),type:'barcode',x:2,y:2,barcodeH:40,barcodeW:1,showText:true,barcodeData:'{CODE}',rotation:'N'}];
  updateLabelSize();
}

function showToast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2500)}

document.addEventListener('DOMContentLoaded',()=>{
  elements.push({id:Date.now(),type:'barcode',x:10,y:10,barcodeH:60,barcodeW:2,showText:true,barcodeData:'{CODE}',rotation:'N'});
  updateLabelSize();
  renderCodes();
});

document.getElementById('labelCanvas').onclick=e=>{if(e.target.id==='labelCanvas'){selectedId=null;renderElements();updatePropsPanel()}};
</script>
</body>
</html>
